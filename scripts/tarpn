#!/bin/bash
#
# TARPN Node Management Command
# https://github.com/dpaschal/tarpn-node
#

set -e

TARPN_DIR="/opt/tarpn"
LINBPQ_DIR="$TARPN_DIR/linbpq"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Show usage
usage() {
    cat << EOF
TARPN Node Management v$VERSION

Usage: tarpn <command> [options]

Node Control:
  (no command)     Show node status
  config           Interactive node configuration
  test             Run node interactively (for testing)
  service          Manage background service (start|stop|restart|status)

Monitoring:
  log              View node logs (live)
  daemon           View daemon.log
  listen <port>    Monitor packets on specified port
  linktest <port>  Test link quality (sends 100 packets)
  shell            Open BPQ command shell (telnet)
  tx <node>        Telnet to neighbor node

USB/TNC:
  usb              List USB devices and TNCs
  identify         Identify connected TNC hardware
  flash            Flash firmware to NinoTNC

Network:
  ip               Show IP configuration
  ports            Show open network ports

Updates:
  update           Update TARPN scripts from GitHub
  updateapps       Update system applications

Backup/Restore:
  backup           Backup node configuration
  restore          Restore from backup

System:
  info             Show system information
  shutdown         Safely shutdown node and Pi
  reboot           Safely reboot node
  forceshutdown    Force immediate shutdown

Web Interface:
  home             Manage TARPN-HOME (start|stop|status|logs)

Advanced:
  ps               Show process tree
  stresstest       Stress test links to neighbors

EOF
}

# Check if BPQ is running
is_running() {
    pgrep -f "linbpq" > /dev/null 2>&1
}

# Show status
status() {
    echo -e "${BLUE}TARPN Node Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    if is_running; then
        echo -e "BPQ Node: ${GREEN}RUNNING${NC}"
        PID=$(pgrep -f "linbpq")
        echo "  PID: $PID"
        echo "  Uptime: $(ps -o etime= -p $PID | xargs)"
    else
        echo -e "BPQ Node: ${RED}NOT RUNNING${NC}"
    fi

    echo ""

    # Show IP
    IP=$(hostname -I | awk '{print $1}')
    echo "Network:"
    echo "  IP Address: $IP"
    echo "  Web Interface: http://$IP:8080"

    echo ""

    # Show USB devices (TNCs)
    echo "USB Devices:"
    for dev in /dev/ttyUSB*; do
        if [[ -e "$dev" ]]; then
            echo "  $dev"
        fi
    done

    if [[ ! -e /dev/ttyUSB0 ]]; then
        echo -e "  ${YELLOW}No USB devices found${NC}"
    fi
}

# Interactive configuration
config() {
    echo -e "${BLUE}TARPN Node Configuration${NC}"
    echo ""

    if is_running; then
        echo -e "${YELLOW}Warning: Node is running. Stop it first with 'tarpn service stop'${NC}"
        read -p "Stop node and continue? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            service_cmd stop
        else
            exit 1
        fi
    fi

    CONFIG_FILE="$LINBPQ_DIR/bpq32.cfg"

    # Backup existing config
    if [[ -f "$CONFIG_FILE" ]]; then
        cp "$CONFIG_FILE" "$CONFIG_FILE.bak.$(date +%Y%m%d_%H%M%S)"
    fi

    echo "Current configuration: $CONFIG_FILE"
    echo ""

    # Interactive prompts
    read -p "Your callsign: " CALLSIGN
    CALLSIGN=$(echo "$CALLSIGN" | tr '[:lower:]' '[:upper:]')

    read -p "Node callsign (e.g., ${CALLSIGN}-2): " NODECALL
    NODECALL=${NODECALL:-"${CALLSIGN}-2"}

    read -p "Node name (6 chars max): " NODEALIAS
    NODEALIAS=$(echo "$NODEALIAS" | tr '[:lower:]' '[:upper:]' | cut -c1-6)

    read -p "BBS callsign (e.g., ${CALLSIGN}-1): " BBSCALL
    BBSCALL=${BBSCALL:-"${CALLSIGN}-1"}

    read -p "Grid locator (e.g., EM95): " LOCATOR

    echo ""
    echo "Configuration:"
    echo "  Callsign: $CALLSIGN"
    echo "  Node: $NODECALL ($NODEALIAS)"
    echo "  BBS: $BBSCALL"
    echo "  Locator: $LOCATOR"
    echo ""

    read -p "Save this configuration? [Y/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        # Update config file
        sed -i "s/NODECALL=.*/NODECALL=$NODECALL/" "$CONFIG_FILE"
        sed -i "s/NODEALIAS=.*/NODEALIAS=$NODEALIAS/" "$CONFIG_FILE"
        sed -i "s/LOCATOR=.*/LOCATOR=$LOCATOR/" "$CONFIG_FILE"
        echo -e "${GREEN}Configuration saved${NC}"
    fi
}

# Service management
service_cmd() {
    case "$1" in
        start)
            echo "Starting TARPN node..."
            sudo systemctl start tarpn
            sleep 2
            if is_running; then
                echo -e "${GREEN}Node started${NC}"
            else
                echo -e "${RED}Failed to start node${NC}"
                exit 1
            fi
            ;;
        stop)
            echo "Stopping TARPN node..."
            sudo systemctl stop tarpn
            echo -e "${GREEN}Node stopped${NC}"
            ;;
        restart)
            echo "Restarting TARPN node..."
            sudo systemctl restart tarpn
            sleep 2
            if is_running; then
                echo -e "${GREEN}Node restarted${NC}"
            else
                echo -e "${RED}Failed to restart node${NC}"
                exit 1
            fi
            ;;
        status)
            sudo systemctl status tarpn
            ;;
        *)
            echo "Usage: tarpn service [start|stop|restart|status]"
            ;;
    esac
}

# Run interactive test
test_node() {
    echo -e "${BLUE}Running node in interactive mode...${NC}"
    echo "Press Ctrl+C to stop"
    echo ""

    cd "$LINBPQ_DIR"
    ./linbpq
}

# Update TARPN
update() {
    echo -e "${BLUE}Updating TARPN...${NC}"

    cd "$TARPN_DIR"
    git pull

    echo -e "${GREEN}Update complete${NC}"
    echo "Restart the node with 'tarpn service restart' to apply changes"
}

# Backup
backup() {
    BACKUP_DIR="$TARPN_DIR/backups"
    BACKUP_FILE="$BACKUP_DIR/tarpn-backup-$(date +%Y%m%d_%H%M%S).tar.gz"

    mkdir -p "$BACKUP_DIR"

    echo "Creating backup..."

    tar -czf "$BACKUP_FILE" \
        -C "$LINBPQ_DIR" \
        bpq32.cfg \
        linmail.cfg \
        chatconfig.cfg \
        2>/dev/null || true

    echo -e "${GREEN}Backup saved: $BACKUP_FILE${NC}"
}

# View logs
view_log() {
    if [[ -d "$LINBPQ_DIR/Logs" ]]; then
        LOG=$(ls -t "$LINBPQ_DIR/Logs"/*.log 2>/dev/null | head -1)
        if [[ -n "$LOG" ]]; then
            tail -f "$LOG"
        else
            echo "No log files found"
        fi
    else
        echo "Log directory not found"
    fi
}

# System info
sysinfo() {
    echo -e "${BLUE}System Information${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    echo "Hostname: $(hostname)"
    echo "IP: $(hostname -I | awk '{print $1}')"
    echo "Uptime: $(uptime -p)"
    echo ""

    echo "CPU:"
    grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs
    echo "  Load: $(cat /proc/loadavg | awk '{print $1, $2, $3}')"
    echo ""

    echo "Memory:"
    free -h | grep Mem | awk '{print "  Total: "$2"  Used: "$3"  Free: "$4}'
    echo ""

    echo "Disk:"
    df -h / | tail -1 | awk '{print "  Total: "$2"  Used: "$3"  Free: "$4" ("$5" used)"}'
    echo ""

    echo "Temperature:"
    if [[ -f /sys/class/thermal/thermal_zone0/temp ]]; then
        TEMP=$(cat /sys/class/thermal/thermal_zone0/temp)
        echo "  CPU: $((TEMP/1000))°C"
    else
        echo "  N/A"
    fi
}

# Safe shutdown
shutdown_node() {
    echo -e "${YELLOW}Shutting down TARPN node...${NC}"

    if is_running; then
        service_cmd stop
    fi

    sync
    echo "System will shutdown in 5 seconds..."
    sleep 5
    sudo shutdown -h now
}

# Safe reboot
reboot_node() {
    echo -e "${YELLOW}Rebooting TARPN node...${NC}"

    if is_running; then
        service_cmd stop
    fi

    sync
    echo "System will reboot in 5 seconds..."
    sleep 5
    sudo reboot
}

# Force shutdown (no delay)
force_shutdown() {
    echo -e "${RED}Force shutting down...${NC}"
    sync
    sudo shutdown -h now
}

# List USB devices and TNCs
list_usb() {
    echo -e "${BLUE}USB Devices${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # List all ttyUSB devices
    for dev in /dev/ttyUSB*; do
        if [[ -e "$dev" ]]; then
            echo ""
            echo -e "${GREEN}$dev${NC}"

            # Try to get device info from udevadm
            INFO=$(udevadm info -q property "$dev" 2>/dev/null)
            if [[ -n "$INFO" ]]; then
                VENDOR=$(echo "$INFO" | grep "ID_VENDOR=" | cut -d= -f2)
                MODEL=$(echo "$INFO" | grep "ID_MODEL=" | cut -d= -f2)
                SERIAL=$(echo "$INFO" | grep "ID_SERIAL_SHORT=" | cut -d= -f2)

                [[ -n "$VENDOR" ]] && echo "  Vendor: $VENDOR"
                [[ -n "$MODEL" ]] && echo "  Model: $MODEL"
                [[ -n "$SERIAL" ]] && echo "  Serial: $SERIAL"
            fi
        fi
    done

    if [[ ! -e /dev/ttyUSB0 ]]; then
        echo ""
        echo -e "${YELLOW}No USB serial devices found${NC}"
        echo "NinoTNCs should appear as /dev/ttyUSB* when connected"
    fi

    echo ""
    echo "Also checking ttyACM devices..."
    for dev in /dev/ttyACM*; do
        if [[ -e "$dev" ]]; then
            echo -e "${GREEN}$dev${NC}"
        fi
    done
}

# Identify TNC
identify_tnc() {
    echo -e "${BLUE}TNC Identification${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    for dev in /dev/ttyUSB*; do
        if [[ -e "$dev" ]]; then
            echo ""
            echo "Checking $dev..."

            # Try to read TNC version (NinoTNC responds to version query)
            if command -v python3 &>/dev/null; then
                python3 << EOF 2>/dev/null || echo "  Could not query device"
import serial
import time
try:
    ser = serial.Serial('$dev', 57600, timeout=2)
    time.sleep(0.5)
    ser.write(b'\\x1b[V')  # Version query
    time.sleep(0.5)
    response = ser.read(100)
    if response:
        print(f"  Response: {response.decode('utf-8', errors='ignore').strip()}")
    else:
        print("  No response (may not be a NinoTNC)")
    ser.close()
except Exception as e:
    print(f"  Error: {e}")
EOF
            else
                echo "  Python3 required for TNC identification"
            fi
        fi
    done
}

# Flash NinoTNC firmware
flash_tnc() {
    echo -e "${BLUE}NinoTNC Firmware Flash${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    FIRMWARE_DIR="/usr/local/etc/ninotnc/versions"

    if [[ ! -d "$FIRMWARE_DIR" ]]; then
        echo -e "${RED}Firmware directory not found: $FIRMWARE_DIR${NC}"
        exit 1
    fi

    # List available firmware
    echo "Available firmware versions:"
    ls -1 "$FIRMWARE_DIR"/*.hex 2>/dev/null || echo "  No firmware files found"
    echo ""

    # List USB devices
    echo "Available USB devices:"
    for dev in /dev/ttyUSB*; do
        [[ -e "$dev" ]] && echo "  $dev"
    done
    echo ""

    echo "To flash firmware, download flashtnc.py from TARPN and run:"
    echo "  python3 flashtnc.py <device> <firmware.hex>"
}

# Show IP configuration
show_ip() {
    echo -e "${BLUE}IP Configuration${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    ip -4 addr show | grep -E "inet|^[0-9]"
    echo ""
    echo "Default gateway:"
    ip route | grep default
}

# Show open ports
show_ports() {
    echo -e "${BLUE}Open Network Ports${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    ss -tlnp 2>/dev/null || netstat -tlnp 2>/dev/null
}

# Show process tree
show_ps() {
    echo -e "${BLUE}Process Tree${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    pstree -p 2>/dev/null || ps auxf
}

# View daemon log
view_daemon() {
    if [[ -f "$LINBPQ_DIR/Logs/daemon.log" ]]; then
        tail -f "$LINBPQ_DIR/Logs/daemon.log"
    else
        echo "daemon.log not found"
    fi
}

# Listen to port traffic
listen_port() {
    PORT=$1
    if [[ -z "$PORT" ]]; then
        echo "Usage: tarpn listen <port_number>"
        exit 1
    fi

    echo -e "${BLUE}Listening on port $PORT${NC}"
    echo "Press Ctrl+C to stop"
    echo ""

    # Connect to BPQ monitor for this port
    telnet localhost 8010 << EOF 2>/dev/null
MON $PORT
EOF
}

# Link test
link_test() {
    PORT=$1
    if [[ -z "$PORT" ]]; then
        echo "Usage: tarpn linktest <port_number>"
        exit 1
    fi

    echo -e "${BLUE}Link Test on Port $PORT${NC}"
    echo "Sending 100 test packets..."
    echo ""

    # This would send test packets via BPQ
    # Implementation depends on having a link test utility
    echo "Link test requires BPQ to be running and a neighbor on the port"
    echo "Use 'tarpn shell' to access BPQ commands manually"
}

# Telnet to neighbor
tx_neighbor() {
    NODE=$1
    if [[ -z "$NODE" ]]; then
        echo "Usage: tarpn tx <node_callsign>"
        exit 1
    fi

    echo -e "${BLUE}Connecting to $NODE...${NC}"
    # Connect via BPQ
    telnet localhost 8010 << EOF
C $NODE
EOF
}

# Restore from backup
restore_backup() {
    BACKUP_DIR="$TARPN_DIR/backups"

    echo -e "${BLUE}Available Backups${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    if [[ ! -d "$BACKUP_DIR" ]]; then
        echo "No backup directory found"
        exit 1
    fi

    ls -lh "$BACKUP_DIR"/*.tar.gz 2>/dev/null || echo "No backups found"
    echo ""

    read -p "Enter backup filename to restore: " BACKUP_FILE

    if [[ ! -f "$BACKUP_DIR/$BACKUP_FILE" ]] && [[ ! -f "$BACKUP_FILE" ]]; then
        echo -e "${RED}Backup file not found${NC}"
        exit 1
    fi

    [[ -f "$BACKUP_DIR/$BACKUP_FILE" ]] && BACKUP_FILE="$BACKUP_DIR/$BACKUP_FILE"

    echo "Restoring from $BACKUP_FILE..."
    tar -xzf "$BACKUP_FILE" -C "$LINBPQ_DIR"
    echo -e "${GREEN}Restore complete${NC}"
}

# Update system applications
update_apps() {
    echo -e "${BLUE}Updating system applications...${NC}"
    sudo apt-get update
    sudo apt-get upgrade -y
    echo -e "${GREEN}Update complete${NC}"
}

# TARPN-HOME management
home_cmd() {
    case "$1" in
        start)
            echo "Starting TARPN-HOME..."
            sudo systemctl start tarpn-home 2>/dev/null || echo "TARPN-HOME service not installed"
            ;;
        stop)
            echo "Stopping TARPN-HOME..."
            sudo systemctl stop tarpn-home 2>/dev/null || echo "TARPN-HOME service not installed"
            ;;
        status)
            sudo systemctl status tarpn-home 2>/dev/null || echo "TARPN-HOME service not installed"
            ;;
        logs)
            if [[ -f /var/log/tarpn_home.log ]]; then
                tail -f /var/log/tarpn_home.log
            else
                echo "TARPN-HOME log not found"
            fi
            ;;
        *)
            echo "Usage: tarpn home [start|stop|status|logs]"
            ;;
    esac
}

# Main command handler
case "${1:-}" in
    "")
        status
        ;;
    config)
        config
        ;;
    test)
        test_node
        ;;
    service)
        service_cmd "$2"
        ;;
    home)
        home_cmd "$2"
        ;;
    update)
        update
        ;;
    updateapps)
        update_apps
        ;;
    backup)
        backup
        ;;
    restore)
        restore_backup
        ;;
    linktest)
        link_test "$2"
        ;;
    listen)
        listen_port "$2"
        ;;
    log)
        view_log
        ;;
    daemon)
        view_daemon
        ;;
    shell)
        telnet localhost 8010
        ;;
    tx)
        tx_neighbor "$2"
        ;;
    usb)
        list_usb
        ;;
    identify)
        identify_tnc
        ;;
    flash)
        flash_tnc
        ;;
    ip)
        show_ip
        ;;
    ports)
        show_ports
        ;;
    ps)
        show_ps
        ;;
    shutdown)
        shutdown_node
        ;;
    reboot)
        reboot_node
        ;;
    forceshutdown)
        force_shutdown
        ;;
    info|sysinfo)
        sysinfo
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
